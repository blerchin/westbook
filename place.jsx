#include "json2.js"#include "underscore.js"var storyFile = File("/opt/westbook/ben_lerchin.com.json");var stories = null;var content;storyFile.open('r');content = storyFile.read();stories = JSON.parse(content);storyFile.close();var styles = [    "source",    "headline",    "deck",    "story",    "link"];var document = app.open("/opt/westbook/westbook-template.indd");var frames= document.textFrames;for (var i=0; i < frames.length; i++) {   fillFrame(frames[i]); }function getRequirements(group) {    var requirements = group.name.split("::")[1];    if (!requirements || "-1" == group.name.indexOf('story')) {        return false;    }    return requirements.split(",");}function findStory(requirements) {    var story = null;    var id = 0;    var cur;    var ok;    var req;    var props;    var clean;    while (!story && id < stories.length) {        cur = stories[id];        props = _.keys(cur);        clean = {}        for (var i=0; i<props.length; i++) {            if(cur[props[i]] && cur[props[i]].length !== 0 && props[i] !== "id") {                clean[props[i]] = cur[props[i]];             }        }        $.writeln(_.difference(_.keys(cur), requirements));        ok = _.difference(_.keys(cur), requirements).length;        if (ok && !cur.used) {            story = cur;            story.used = true;        }        id++;    }    return story;}function fillFrame(frame) {    var reqs = getRequirements(frame);    if (!reqs) {        return false;    }    var story = findStory(reqs);    if (!story) {        return false;    }    var i, cur, style;    frame.parentStory.contents = "";    var usedStyles = [];    for(i=0; i<styles.length; i++) {        cur = styles[i];        style = document.paragraphStyles.item(cur);        if(story[cur] && story[cur].length) {            frame.parentStory.contents += story[cur] + "\r";            usedStyles.push(cur);        }    }    frame.parentStory.paragraphs.itemByRange(0, frame.parentStory.paragraphs.length - 1).applyParagraphStyle(document.paragraphStyles.item("story"));    for (var i=0; i < usedStyles.length; i++) {        frame.parentStory.paragraphs.item(i).applyParagraphStyle(document.paragraphStyles.item(usedStyles[i]));    }    frame.parentStory.paragraphs.lastItem().applyParagraphStyle(document.paragraphStyles.item("link"));}